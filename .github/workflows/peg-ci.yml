#
# PEG (Promptable Engineer GPT) Continuous Integration Workflow
#
# This workflow automates the validation, testing, and scoring of the PEG
# repository on every push and pull request. It serves as a quality gate
# to ensure that no broken or low-quality changes are merged.
#
name: PEG CI

# Triggers the workflow on push or pull request events
on: [push, pull_request]

jobs:
  validate-test-score:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    env:
      # Core API Keys
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # E-commerce API Keys (Optional - used for integration tests if available)
      SHOPIFY_SHOP_URL: ${{ secrets.SHOPIFY_SHOP_URL }}
      SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
      ETSY_API_KEY: ${{ secrets.ETSY_API_KEY }}
      ETSY_SHOP_ID: ${{ secrets.ETSY_SHOP_ID }}
      ETSY_ACCESS_TOKEN: ${{ secrets.ETSY_ACCESS_TOKEN }}

      # APEG Configuration
      APEG_TEST_MODE: 'true'
      APEG_USE_LLM_SCORING: 'false'

    steps:
      # Step 1: Check out the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Install dependencies and expose secrets
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 3.5: Create environment file for tests
      - name: Create test environment file
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> .env
          echo "GITHUB_PAT=${{ secrets.GITHUB_TOKEN }}" >> .env

      # Step 4: Validate the repository's file structure and JSON integrity
      - name: Validate Repository Structure
        run: python validate_repo.py
        env:
          PYTHONIOENCODING: utf-8

      # Step 5: Validate APEG environment configuration
      - name: Validate APEG Environment
        run: python -m apeg_core validate
        continue-on-error: true

      # Step 6: Run the scoring model to evaluate prompt quality
      # CORRECTION: Added the required --input argument with a placeholder file.
      - name: Run Scoring
        run: python run_scoring.py --model PromptScoreModel.json --input README.md --out score.json

      # Step 7: Run the automated test suite with coverage reporting
      - name: Run Tests with Coverage
        run: |
          python -m pytest \
            --junitxml=test-results/results.xml \
            --cov=src/apeg_core \
            --cov-report=term \
            --cov-report=html:coverage-html \
            --cov-report=xml:coverage.xml \
            tests/
        env:
          PYTHONIOENCODING: utf-8
          APEG_TEST_MODE: 'true'

      # Step 8: Upload coverage reports
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: coverage-reports
          path: |
            coverage.xml
            coverage-html/

      # Step 9: Upload test results and scoring artifacts
      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: peg-artifacts
          path: |
            score.json
            test-results/

  integration-tests:
    # Integration tests that can use real API calls when credentials are available
    runs-on: ubuntu-latest
    needs: validate-test-score
    env:
      # Core API Keys
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # E-commerce API Keys (Optional)
      SHOPIFY_SHOP_URL: ${{ secrets.SHOPIFY_SHOP_URL }}
      SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
      ETSY_API_KEY: ${{ secrets.ETSY_API_KEY }}
      ETSY_SHOP_ID: ${{ secrets.ETSY_SHOP_ID }}
      ETSY_ACCESS_TOKEN: ${{ secrets.ETSY_ACCESS_TOKEN }}

      # APEG Configuration - Integration tests with mocked APIs
      APEG_TEST_MODE: 'false'
      APEG_USE_LLM_SCORING: 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create environment file
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> .env
          echo "GITHUB_PAT=${{ secrets.GITHUB_TOKEN }}" >> .env
          echo "SHOPIFY_SHOP_URL=${{ secrets.SHOPIFY_SHOP_URL }}" >> .env
          echo "SHOPIFY_ACCESS_TOKEN=${{ secrets.SHOPIFY_ACCESS_TOKEN }}" >> .env
          echo "ETSY_API_KEY=${{ secrets.ETSY_API_KEY }}" >> .env
          echo "ETSY_SHOP_ID=${{ secrets.ETSY_SHOP_ID }}" >> .env
          echo "ETSY_ACCESS_TOKEN=${{ secrets.ETSY_ACCESS_TOKEN }}" >> .env
          echo "APEG_TEST_MODE=false" >> .env
          echo "APEG_USE_LLM_SCORING=true" >> .env

      - name: Run Integration Tests
        run: |
          python -m pytest \
            --junitxml=integration-results/results.xml \
            -v \
            -m integration \
            tests/
        continue-on-error: true
        env:
          PYTHONIOENCODING: utf-8

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: integration-test-results
          path: integration-results/
