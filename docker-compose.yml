version: '3.8'

# APEG System Docker Compose
# For local development and production deployment

services:
  apeg:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: apeg-server
    ports:
      - "${APEG_PORT:-8000}:8000"
    environment:
      # System mode
      - APEG_TEST_MODE=${APEG_TEST_MODE:-true}
      - APEG_DEBUG=${APEG_DEBUG:-false}

      # Shopify credentials (set in .env)
      - SHOPIFY_STORE_DOMAIN=${SHOPIFY_STORE_DOMAIN:-}
      - SHOPIFY_ACCESS_TOKEN=${SHOPIFY_ACCESS_TOKEN:-}

      # Etsy credentials (set in .env)
      - ETSY_API_KEY=${ETSY_API_KEY:-}
      - ETSY_API_SECRET=${ETSY_API_SECRET:-}
      - ETSY_SHOP_ID=${ETSY_SHOP_ID:-}

      # OpenAI API key for LLM features
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

    volumes:
      # Configuration files
      - ./config:/app/config:ro
      - ./webui:/app/webui:ro

      # Logs (writable)
      - apeg-logs:/app/logs

      # JSON configuration files
      - ./WorkflowGraph.json:/app/WorkflowGraph.json:ro
      - ./Agent_Prompts.json:/app/Agent_Prompts.json:ro
      - ./Rules.json:/app/Rules.json:ro
      - ./Knowledge.json:/app/Knowledge.json:ro

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - apeg-network

# Optional services for production
# Uncomment as needed

#  # Redis for caching (future enhancement)
#  redis:
#    image: redis:7-alpine
#    container_name: apeg-redis
#    ports:
#      - "6379:6379"
#    volumes:
#      - redis-data:/data
#    restart: unless-stopped
#    networks:
#      - apeg-network

#  # Nginx reverse proxy (for HTTPS)
#  nginx:
#    image: nginx:alpine
#    container_name: apeg-nginx
#    ports:
#      - "80:80"
#      - "443:443"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - ./certs:/etc/nginx/certs:ro
#    depends_on:
#      - apeg
#    restart: unless-stopped
#    networks:
#      - apeg-network

volumes:
  apeg-logs:
    driver: local
#  redis-data:
#    driver: local

networks:
  apeg-network:
    driver: bridge
