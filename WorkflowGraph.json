{
  "version": "2.1.0",
  "description": "The single source of truth for PEG session orchestration. Defines the execution graph, nodes, conditional edges, and agent roles.",
  "metadata": {
    "updated_at": "2025-07-30T03:15:00-04:00",
    "author": "PEG Orchestrator"
  },
  "agent_roles": {
    "PEG": "Session orchestrator and final arbiter; controls fallback, confirms resolution, logs via LOGGER.",
    "ENGINEER": "Designs macro chains, prompt logic, injects constraints from objective.",
    "VALIDATOR": "Validates prompt structure, schema conformance, DSL/JSON output per enforcement rules.",
    "CHALLENGER": "Stress-tests logic chains, triggers fallback if structural or logic flaws detected.",
    "LOGGER": "Audits file changes, macro mutations, agent actions, and scoring logs.",
    "SCORER": "Scores outputs using the PromptScoreModel.",
    "TESTER": "Injects regression and edge tests from the test suite."
  },
  "nodes": [
    {
      "id": "intake",
      "label": "Intake",
      "type": "start",
      "agent": "PEG",
      "action": "load_tags,init_context,assign_roles"
    },
    {
      "id": "prep",
      "label": "Prep",
      "type": "process",
      "agent": "PEG",
      "action": "load_json(Tasks.json),next_checklist,load_macros,load_rules"
    },
    {
      "id": "build",
      "label": "Build Prompt",
      "type": "process",
      "agent": "ENGINEER",
      "action": "build_prompt_logic,inject_constraints,assign_agents"
    },
    {
      "id": "review",
      "label": "Review & Score",
      "type": "decision",
      "agent": "VALIDATOR",
      "action": "validate_prompt,score_output,log_mutation"
    },
    {
      "id": "loop_detector",
      "label": "Macro Loop Detector",
      "type": "decision",
      "agent": "PEG",
      "action": "detect_macro_loop"
    },
    {
      "id": "reroute",
      "label": "Reroute with New Macro",
      "type": "process",
      "agent": "PEG",
      "action": "dsl:choose_best_macro"
    },
    {
      "id": "fallback",
      "label": "Fallback Repair",
      "type": "process",
      "agent": "CHALLENGER",
      "action": "auto_correct_prompt,revalidate,score_again"
    },
    {
      "id": "external_call",
      "label": "External API Call",
      "type": "trigger",
      "condition": "tag_present(#EXTERNAL_CALL)",
      "action": "call_openai_chat"
    },
    {
      "id": "export",
      "label": "Wrap & Export",
      "type": "end",
      "agent": "PEG",
      "action": "output_to_console,log_to_logbook,autoexport"
    },
    {
      "id": "mcp_tool_call",
      "label": "MCP Tool Call (Example)",
      "type": "mcp_tool",
      "description": "Example MCP tool node - not included in default workflow",
      "agent": "PEG",
      "mcp_config": {
        "server": "default",
        "tool_name": "example_tool",
        "input_mapping": {
          "input": "context.user_input"
        },
        "output_mapping": {
          "mcp_result": "result.output"
        }
      }
    }
  ],
  "_mcp_node_schema": {
    "description": "MCP Tool Node Type (EXPERIMENTAL) - Call external tools via Model Context Protocol",
    "type": "mcp_tool",
    "status": "EXPERIMENTAL - Test mode only, production integration pending",
    "config": {
      "server": "Server identifier (e.g., filesystem, web_search, database)",
      "tool_name": "Tool name to invoke (e.g., read_file, search, query)",
      "input_mapping": {
        "description": "Maps workflow state to tool parameters",
        "format": "Parameter name -> State path (e.g., 'path': 'file_path')",
        "example": {
          "path": "file_path",
          "query": "search_query"
        },
        "notes": "Use simple state keys (e.g., 'file_path') not dot notation"
      },
      "output_mapping": {
        "description": "Maps tool response to workflow state",
        "format": "State key -> Result path (e.g., 'file_content': 'result.content')",
        "example": {
          "file_content": "result.content",
          "search_results": "result.results"
        },
        "notes": "Use 'result.' prefix to extract nested values from tool response"
      }
    },
    "example_usage": {
      "filesystem_read": {
        "id": "read_config",
        "type": "mcp_tool",
        "description": "Read configuration file",
        "mcp_config": {
          "server": "filesystem",
          "tool_name": "read_file",
          "input_mapping": {
            "path": "config_path"
          },
          "output_mapping": {
            "config_data": "result.content"
          }
        }
      },
      "web_search": {
        "id": "search_docs",
        "type": "mcp_tool",
        "description": "Search documentation",
        "mcp_config": {
          "server": "web_search",
          "tool_name": "search",
          "input_mapping": {
            "query": "search_query"
          },
          "output_mapping": {
            "search_results": "result.results"
          }
        }
      },
      "database_query": {
        "id": "fetch_data",
        "type": "mcp_tool",
        "description": "Query database",
        "mcp_config": {
          "server": "database",
          "tool_name": "query",
          "input_mapping": {
            "sql": "query_string"
          },
          "output_mapping": {
            "query_results": "result.rows"
          }
        }
      }
    },
    "error_handling": {
      "description": "MCP errors are stored in state['_mcp_error'] and workflow continues",
      "success_result": "action_result = 'success'",
      "failure_result": "action_result = 'mcp_failed'",
      "error_storage": "state['_mcp_error'] contains error message if call fails"
    }
  },
  "edges": [
    { "from": "intake", "to": "prep" },
    { "from": "prep", "to": "build" },
    { "from": "build", "to": "review" },
    { "from": "review", "to": "export", "condition": "score_passed" },
    { "from": "review", "to": "external_call", "condition": "tag_present(#EXTERNAL_CALL)" },
    { "from": "review", "to": "loop_detector", "condition": "validation_failed" },
    { "from": "loop_detector", "to": "reroute", "condition": "loop_not_detected" },
    { "from": "loop_detector", "to": "fallback", "condition": "loop_detected" },
    { "from": "reroute", "to": "build" },
    { "from": "fallback", "to": "review" },
    { "from": "external_call", "to": "export" }
  ]
}
